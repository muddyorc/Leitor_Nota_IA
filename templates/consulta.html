{% extends "layout.html" %}

{% block title %}Consulta RAG{% endblock %}

{% block content %}
<section class="panel">
  <div class="panel-header">
    <div>
      <h1>Consulta Analítica (RAG)</h1>
      <p class="page-subtitle">Explore as contas cadastradas utilizando busca direta (SQL) ou semântica.</p>
    </div>
  </div>

  <form id="consultaForm" class="rag-form card">
    <div class="form-group">
      <label for="modo">Modo de busca</label>
      <select id="modo" name="modo">
        <option value="simples">RAG Simples (SQL)</option>
        <option value="semantico">RAG Semântico (Embeddings)</option>
      </select>
    </div>

    <div class="form-group">
      <label for="pergunta">Pergunta</label>
      <textarea id="pergunta" name="pergunta" rows="6" placeholder="Digite sua pergunta..."></textarea>
    </div>

    <div class="form-actions">
      <button type="submit">Consultar</button>
    </div>
  </form>

  <div class="card response-card">
    <h2>Resposta</h2>
    <div id="resposta">Nenhuma consulta realizada ainda.</div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  const form = document.getElementById('consultaForm');
  const respostaDiv = document.getElementById('resposta');

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    respostaDiv.textContent = 'Processando...';

    const modo = document.getElementById('modo').value;
    const pergunta = document.getElementById('pergunta').value;

    try {
      const response = await fetch('/consultar_rag', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ modo, pergunta })
      });

      const data = await response.json();
      if (!response.ok) {
        respostaDiv.textContent = JSON.stringify(data, null, 2);
        return;
      }

      respostaDiv.textContent = data.resposta || JSON.stringify(data, null, 2);
    } catch (error) {
      respostaDiv.textContent = 'Erro: ' + error.message;
    }
  });
</script>
{% endblock %}
